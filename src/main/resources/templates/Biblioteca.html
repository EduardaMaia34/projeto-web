<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Biblioteca - Bookly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Unicase:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f5f4ed;
            font-family: 'Cormorant Unicase', serif;
            color: #594A47;
        }

        .header-bar { background-color: #DED2C2; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .book-grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .book-card {
            width: 150px;
            text-align: center;
            flex-shrink: 0;
        }
        .book-cover {
            width: 100%;
            height: 225px;
            object-fit: cover;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .star-rating {
            font-size: 1.2rem;
            color: gold; /* Define a cor principal como gold */
            margin-top: 5px;
            display: block;
        }
        /* Estrela vazia em cinza claro */
        .star-rating i.bi-star {
            color: lightgray !important;
        }

        .search-bar-hidden {
            width: 0;
            opacity: 0;
            transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }

        .search-bar-visible-navbar {
            width: 300px;
            opacity: 1;
            margin-right: 15px;
            border-radius: 5px;
        }

        .profile-group-hidden {
            display: none !important;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .search-bar-visible-estante {
            width: 300px;
            opacity: 1;
            margin-left: 15px;
            border-radius: 5px;
        }

        .btn-link.text-dark, .btn-link {
            color: #594A47 !important;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light header-bar p-3 mb-4">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" >
            <img src="https://imgur.com/HLvpHYn.png" alt="Bookly Logo" height="30" class="d-inline-block align-text-top me-2" style="height: 50px">
        </a>

        <div class="d-flex align-items-center ms-auto">

            <div id="searchBarContainerNavbar" class="search-bar-hidden">
                <input type="text" id="searchInputNavbar" class="form-control" placeholder="Pesquisar livros, autores...">
            </div>

            <button class="btn btn-link text-dark me-3" id="searchToggleBtnNavbar">
                <i class="bi bi-search"></i>
            </button>

            <div id="profileGroupNavbar" class="d-flex align-items-center">

                <a href="perfil.html" class="d-flex align-items-center me-3">
                    <img src="https://imgur.com/pcf2EUA.png" alt="Perfil Mari" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;">
                </a>

                <span class="fw-bold me-3">Mari</span>
                <button class="btn btn-success me-3 d-flex align-items-center">
                    <span style="font-size: 1.2rem; line-height: 1;">+</span> Livro
                </button>
                <button class="btn btn-link text-dark">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 id="pageTitle">Minha Biblioteca</h3>

        <div class="d-flex align-items-center">

            <div id="searchBarEstanteContainer" class="search-bar-hidden">
                <input type="text" id="searchInputEstante" class="form-control" placeholder="Pesquisar livros, autores...">
            </div>

            <button class="btn btn-link text-dark" id="searchToggleBtnEstante">
                <i class="bi bi-search"></i>
            </button>
        </div>

    </div>

    <div id="bookListContainer" class="book-grid">
        <p class="text-muted">Carregando livros...</p>
    </div>

    <div id="pagination-controls" class="d-flex justify-content-center mt-5">
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8081/api/v1';
    const CONTAINER = document.getElementById('bookListContainer');

    const MOCK_JWT_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIyIiwidXNlcm5hbWUiOiJtYXJpM0BnbWFpbC5jb20iLCJyb2xlcyI6IlJPTEVfVVNFUiIsImlhdCI6MTc2Mjg3Nzk3MywiZXhwIjoxNzYyOTY0MzczfQ.sRwC1qqycNrCqb0FSX43AIUWG2tj5O7P0uRF_xdrZBE';

    function displayStarRating(rating) {
        const displayRating = parseFloat(rating) || 0;
        let html = '';

        for (let i = 1; i <= 5; i++) {
            if (i <= displayRating) {
                // Estrela Cheia
                html += '<i class="bi bi-star-fill"></i>';
            } else if (i - 0.5 <= displayRating) {
                // Meia Estrela
                html += '<i class="bi bi-star-half"></i>';
            } else {
                // Estrela Vazia (Será cinza devido ao CSS .star-rating i.bi-star)
                html += '<i class="bi bi-star"></i>';
            }
        }
        return html;
    }

    function createBookCardHtml(item) {
        const livro = item.livro || {};

        const rating = item.nota || 0;
        let starHtml = '';

        if (rating > 0) {
            starHtml = `<span class="star-rating">${displayStarRating(rating)}</span>`;
        }


        const coverUrl = livro.urlCapa ||
            `https://placehold.co/150x225/A0A0A0/FFFFFF?text=${livro.titulo ? livro.titulo.substring(0, 6) : 'Capa'}`;

        const status = item.status || '';

        return `
            <div class="book-card">
                <img src="${coverUrl}" class="book-cover mb-1" alt="Capa de ${livro.titulo || 'Livro Desconhecido'}">
                ${starHtml}
                <small class="d-block text-muted">${status}</small>
            </div>
        `;
    }

    function loadEstante(books) {
        CONTAINER.innerHTML = '';
        if (!books || books.length === 0) {
            CONTAINER.innerHTML = '<p class="text-muted">Sua Biblioteca está vazia. Adicione livros para ler.</p>';
            return;
        }
        books.forEach(book => {
            CONTAINER.innerHTML += createBookCardHtml(book);
        });
    }

    function getFetchConfig() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const token = MOCK_JWT_TOKEN;
        let url;
        let isMyShelf = true;

        if (userId) {
            url = `${API_BASE_URL}/biblioteca/users/${userId}?page=0&size=20`;
            isMyShelf = false;
        } else {
            // Endpoint que busca a Watchlist do usuário logado
            url = `${API_BASE_URL}/biblioteca?page=0&size=20`;
        }
        return { url, isMyShelf, token, userId };
    }

    async function fetchEstante() {
        const config = getFetchConfig();

        if (config.token === 'INSIRA_AQUI_UM_TOKEN_JWT_VALIDO_DE_TESTE') {
            CONTAINER.innerHTML = '<p class="text-danger">ERRO: Insira um token JWT VÁLIDO na variável MOCK_JWT_TOKEN para carregar os dados.</p>';
            return;
        }

        CONTAINER.innerHTML = '<p class="text-muted">Carregando...</p>';
        const headers = { 'Authorization': `Bearer ${config.token}` };

        try {
            const response = await fetch(config.url, {
                method: 'GET',
                headers: headers
            });

            if (response.ok) {
                const pageData = await response.json();
                loadEstante(pageData.content);

                const titleElement = document.getElementById('pageTitle');
                const userDisplay = config.isMyShelf ? 'Minha' : `Biblioteca do Usuário ${config.userId}`;
                titleElement.textContent = `${userDisplay} Biblioteca (Livros para Ler)`;
            } else {
                CONTAINER.innerHTML = `<p class="text-danger">Erro ao carregar a biblioteca: ${response.status}. Verifique se o token é válido e se o CORS está configurado.</p>`;
            }
        } catch (error) {
            CONTAINER.innerHTML = '<p class="text-danger">Erro de conexão com o servidor.</p>';
            console.error('Erro na requisição da biblioteca:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchEstante();

        const searchToggleBtnNavbar = document.getElementById('searchToggleBtnNavbar');
        const searchBarContainerNavbar = document.getElementById('searchBarContainerNavbar');
        const profileGroupNavbar = document.getElementById('profileGroupNavbar');
        const searchInputNavbar = document.getElementById('searchInputNavbar');

        if (searchToggleBtnNavbar) {
            searchToggleBtnNavbar.addEventListener('click', () => {
                const isVisible = searchBarContainerNavbar.classList.toggle('search-bar-visible-navbar');

                if (isVisible) {
                    profileGroupNavbar.classList.add('profile-group-hidden');
                    setTimeout(() => {
                        searchInputNavbar.focus();
                    }, 300);
                } else {
                    profileGroupNavbar.classList.remove('profile-group-hidden');
                    searchInputNavbar.value = '';
                }
            });
        }


        const searchToggleBtnEstante = document.getElementById('searchToggleBtnEstante');
        const searchBarEstanteContainer = document.getElementById('searchBarEstanteContainer');
        const searchInputEstante = document.getElementById('searchInputEstante');

        if (searchToggleBtnEstante) {
            searchToggleBtnEstante.addEventListener('click', () => {
                const isVisible = searchBarEstanteContainer.classList.toggle('search-bar-visible-estante');

                if (isVisible) {
                    setTimeout(() => {
                        searchInputEstante.focus();
                    }, 300);
                } else {
                    searchInputEstante.value = '';
                }
            });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>